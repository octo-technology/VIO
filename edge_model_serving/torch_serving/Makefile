SHELL := /bin/bash
.SHELLFLAGS = -ec
.ONESHELL:
.SILENT:

# brew install openjdk

.PHONY: install
install:
	conda create --name pytorch python=3.9 -y
	conda activate pytorch
	conda install -c pytorch torchvision torchserve torch-model-archiver


.PHONY: download-models
download-models:
	wget https://download.pytorch.org/models/fasterrcnn_resnet50_fpn_coco-258fb6c6.pth
	mv fasterrcnn_resnet50_fpn_coco-258fb6c6.pth ../models/torch/fasterrcnn_resnet50_fpn_coco-258fb6c6.pth


.PHONY: build-mar-file
build-mar-file:
	torch-model-archiver \
	--model-name yolo5 \
	--version 2.1 \
	--serialized-file ../models/torch/yolo5_v2.1.torchscript.pt \
	--handler ./torchserve_handler.py \
	--extra-files ../models/torch/yolo_to_name.json,./torchserve_handler.py

.PHONY: serve
serve:
	torchserve --start --model-store ./models/ --models yolo=yolo5.mar --ts-config ./config.properties --foreground

.PHONY: test
test:
	curl http://127.0.0.1:8080/predictions/yolo -T ../tests/L1\ front.jpg
