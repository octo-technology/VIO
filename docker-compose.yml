services:
  edge_model_serving:
    container_name: edge_model_serving
    build:
      context: edge_model_serving
      dockerfile: tflite_serving/Dockerfile
    environment:
      - TF_CPP_MIN_VLOG_LEVEL=0
    ports:
      - 8501:8501
    profiles: [edge]
    volumes:
      - ./edge_model_serving/models:/models

  edge_orchestrator:
    container_name: edge_orchestrator
    build:
      context: edge_orchestrator
      dockerfile: Dockerfile
    volumes:
      - ./edge_orchestrator/data_storage:/edge_orchestrator/data_storage
    devices:
      - /dev/video0:/dev/video0
      - /dev/video1:/dev/video1
      - /dev/video2:/dev/video2
      - /dev/video3:/dev/video3
    ports:
      - 8000:8000
    environment:
      EDGE_NAME: vio-edge-1
      SERVING_MODEL_URL: http://edge_model_serving:8501
    profiles: [edge]

  hub_labelizer:
    container_name: hub_labelizer
    build:
      context: hub_labelizer
      dockerfile: Dockerfile
    volumes:
      - ./edge_orchestrator/data:/edge_orchestrator/data
    ports:
      - 8100:8100
    environment:
      API_CONFIG: docker
      EDGE_ORCHESTRATOR_URL: http://edge_orchestrator:8000
    profiles: [hub]

  edge_interface:
    container_name: edge_interface
    build:
      context: edge_interface
      dockerfile: Dockerfile
    ports:
      - 8080:80
    profiles: [edge]

  hub_streamlit:
    container_name: hub_streamlit
    build:
      context: hub_streamlit
      dockerfile: Dockerfile
    ports:
      - 8500:8500
    environment:
      GCP_BUCKET_NAME: tf-vio-bucket
      GOOGLE_APPLICATION_CREDENTIALS: /hub_streamlit/config/secrets/credentials.json
    volumes:
      - ./hub_streamlit/config:/hub_streamlit/config
    profiles: [hub]
